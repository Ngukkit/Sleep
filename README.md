# 실시간 운전자 상태 감지 시스템 v0.91

YOLOv5, Dlib, MediaPipe를 활용하여 운전자의 졸음, 하품, 주시 태만 등 다양한 상태를 실시간으로 감지하는 파이썬 기반 시스템입니다.

## 🚀 주요 기능

- **통합 분석 모델**: YOLOv5, Dlib, MediaPipe를 선택적으로 사용하여 운전자의 얼굴과 손을 종합적으로 분석합니다.
- **실시간 상태 시각화**:
    - 감지된 상태(졸음, 하품, 핸들 이탈 등)를 화면에 텍스트와 경고 색상으로 표시합니다.
    - 화면 중앙 상단에 실시간 FPS를 표시하여 성능을 모니터링합니다.
    - 좌측 상단에 YOLOv5의 감지 상태를 표시합니다.
- **동적 설정 관리**:
    - `config.json` 파일을 통해 모든 모델의 주요 파라미터를 중앙에서 관리합니다.
    - GUI의 `Edit Config` 버튼으로 설정 파일을 바로 열어 편집할 수 있습니다.
    - `Reload Config` 버튼으로 프로그램을 재시작하지 않고 변경된 설정을 즉시 반영합니다.
- **개선된 손 감지 시스템**:
    - MediaPipe를 통해 운전자의 손을 실시간으로 감지합니다.
    - **손이 감지되지 않음**: 녹색 (정상) - "Hands on wheel"
    - **한 손이 감지됨**: 노란색 경고 - "Please Hold Steering Wheel"
    - **두 손이 감지됨**: 빨간색 경고 - "HANDS OFF STEERING WHEEL!"
    - `config.json`에서 손 감지 신뢰도와 지속 시간을 조절하여 감지 민감도를 튜닝할 수 있습니다.
- **위험 상태 감지 시스템**:
    - **눈을 감은 상태에서 고개가 숙여지는 경우** 즉시 위험 경고 표시
    - "DANGER: Eyes Closed + Head Down!" 메시지로 강조 표시
    - MediaPipe와 Dlib 모두에서 동일한 위험 상태 감지
    - 시각적으로 큰 폰트와 빨간색으로 경고 표시
- **사용자 친화적 GUI**:
    - 직관적인 UI를 통해 감지 시작/중지, 모델 선택, 영상 소스 선택 등을 쉽게 할 수 있습니다.
    - `Calibrate Front Face` 버튼으로 Dlib과 MediaPipe의 정면 기준점을 동시에 보정합니다.
- **소켓 통신**: 분석 결과를 외부 C++ 서버로 전송하는 기능을 포함하며, GUI에서 활성화/비활성화할 수 있습니다.

## 📝 v0.91 업데이트 내용

### 🎯 얼굴 위치 필터링 시스템 추가
- **운전자 얼굴 캘리브레이션**: 캘리브레이션 시 운전자의 얼굴 위치, 크기, ROI 영역을 저장
- **다른 사람 얼굴 자동 필터링**: 옆자리 승객이나 후방의 다른 사람 얼굴을 자동으로 무시
- **위치 기반 필터링**: 캘리브레이션된 위치에서 얼굴 크기의 30% 이내 편차만 허용
- **크기 기반 필터링**: 캘리브레이션된 크기에서 50% 이내 차이만 허용
- **설정 가능한 임계값**: `config.json`에서 필터링 강도 조절 가능

### 🔧 동적 눈 깜빡임 임계값 (MediaPipe)
- **고개 각도별 임계값 조정**: 고개를 들거나 숙일 때 더 관대한 눈 감음 판정
- **정면 상태**: 기본 임계값 (0.3) 사용
- **고개 들기**: 낮은 임계값 (0.2) - 더 관대한 판정
- **고개 숙이기**: 중간 임계값 (0.25) - 중간 관대도
- **자연스러운 눈 깜빡임**: 고개 각도에 따른 동적 임계값으로 오탐 감소

### 🖐️ 손 크기 필터링 개선
- **얼굴 대비 손 크기 비율**: 손이 얼굴 크기의 2/3보다 작으면 무시
- **후방 승객 손 필터링**: 운전석 뒤의 작은 손들을 자동으로 제외
- **설정 가능한 비율**: `hand_size_ratio_threshold`로 필터링 강도 조절
- **활성화/비활성화**: `enable_hand_size_filtering`으로 기능 제어

### ⚙️ MediaPipe 실행 모드 개선
- **설정 파일 기반 모드 선택**: `config.json`의 `use_video_mode`로 모드 제어
- **VIDEO 모드**: 파일/웹캠용 동기 처리 (기본값)
- **LIVE_STREAM 모드**: 실시간용 비동기 처리
- **GUI에서 모드 선택 제거**: 설정 파일로 통합 관리

### 🔄 설정 시스템 개선
- **얼굴 위치 필터링 설정**: Dlib과 MediaPipe 모두에 적용
- **동적 임계값 설정**: 고개 각도별 눈 깜빡임 임계값
- **손 크기 필터링 설정**: 얼굴 대비 손 크기 비율 임계값
- **설정 문서화**: `README_CONFIG.md`에 새로운 기능 설명 추가

### 🎯 안전성 및 정확도 향상
- **운전자 전용 분석**: 다른 사람의 얼굴을 자동으로 필터링하여 정확도 향상
- **자연스러운 동작 허용**: 고개 각도에 따른 동적 임계값으로 오탐 감소
- **후방 간섭 제거**: 후방 승객의 손이나 얼굴 간섭 방지
- **실시간 캘리브레이션**: 언제든지 "Calibrate Front Face" 버튼으로 재설정 가능

## 📝 v0.90 업데이트 내용

### ⚠️ 위험 상태 감지 시스템 추가
- **눈 감음 + 고개 숙임 동시 감지**: 가장 위험한 졸음 운전 상태를 즉시 감지
- **MediaPipe 위험 감지**: `is_dangerous_condition` 플래그와 `dangerous_condition_message` 추가
- **Dlib 위험 감지**: 동일한 로직으로 위험 상태 감지 및 경고
- **시각적 강조**: 위험 상태 시 큰 폰트와 빨간색으로 "DANGER: Eyes Closed + Head Down!" 표시

### 🔄 MediaPipe 손 감지 로직 개선
- **손 감지 개수별 차별화된 경고 시스템**:
  - 손이 보이지 않음 → 녹색 (정상 상태)
  - 한 손이 보임 → 노란색 경고 ("Please Hold Steering Wheel")
  - 두 손이 보임 → 빨간색 경고 ("HANDS OFF STEERING WHEEL!")

### 🔍 Result Server 업데이트
- 위험 상태 감지 메시지 출력 기능 추가
- ⚠️ 이모지로 위험 상태 강조 표시
- 손 감지 상태 정보 상세 출력
- 실시간 위험 상태 모니터링 가능

### 🎯 안전성 강화
- 운전자의 가장 위험한 상태(눈 감음 + 고개 숙임)를 우선적으로 감지
- 즉시적인 경고 시스템으로 사고 예방 강화
- 다중 분석기(MediaPipe + Dlib)를 통한 신뢰성 향상

### ⚙️ 기타 개선사항
- MediaPipe 상수들을 `config.json`에서 로드하도록 변경
- 불필요한 파일들 제거 및 코드 구조 개선

## 📋 버전 히스토리

### v0.10 - Dlib 모델 개발 및 테스트
- **Dlib 얼굴 랜드마크 감지**: 68개 얼굴 랜드마크를 활용한 정밀한 얼굴 분석
- **눈 종횡비(EAR) 계산**: 눈을 감은 상태를 정확하게 감지
- **하품 감지**: 입이 벌어진 정도를 측정하여 하품 상태 판단
- **고개 자세 감지**: 3D 헤드 포즈 추정으로 고개 방향 분석
- **정면 보정 기능**: 운전자의 정면 기준점을 설정하여 정확한 측정

### v0.20 - YOLO 모델 개발 및 테스트
- **YOLOv5 기반 얼굴 감지**: 빠르고 정확한 얼굴 검출
- **졸음 상태 분류**: 눈을 감은 상태를 이진 분류로 감지
- **실시간 처리**: GPU 가속을 통한 고속 처리
- **다중 얼굴 감지**: 여러 얼굴이 있을 때도 안정적으로 작동

### v0.30 - GUI 통합 (QT5)
- **QT5 기반 GUI**: 사용자 친화적인 인터페이스 구현
- **Dlib + YOLO 통합**: 두 모델을 하나의 인터페이스에서 선택 가능
- **실시간 영상 표시**: 카메라 영상을 GUI에 실시간으로 표시
- **상태 표시**: 감지된 상태를 화면에 텍스트로 표시

### v0.40 - MediaPipe 모델 개발 및 테스트
- **MediaPipe Face Mesh**: 468개 얼굴 랜드마크를 활용한 고정밀 분석
- **손 감지**: MediaPipe Hands를 통한 손 위치 및 제스처 감지
- **눈 감지**: 정밀한 눈 랜드마크를 통한 눈 상태 분석
- **고개 자세**: MediaPipe Pose를 활용한 3D 헤드 포즈 추정
- **크로스 플랫폼**: 다양한 환경에서 안정적으로 작동

### v0.50 - 삼중 모델 통합 GUI
- **모델 선택 기능**: Dlib, YOLO, MediaPipe 중 선택 가능
- **독립적 작동**: 각 모델이 독립적으로 작동하며 결과 비교 가능
- **통합 결과 표시**: 선택된 모델의 결과를 통합하여 표시
- **설정 관리**: 각 모델별 설정을 GUI에서 조정 가능

### v0.60 - 파인튜닝 YOLO 모델 적용 및 배제
- **커스텀 YOLO 모델**: 운전자 졸음 감지에 특화된 파인튜닝 모델 적용
- **성능 테스트**: 기존 모델과의 성능 비교 실험
- **결과 분석**: 정확도와 속도 측면에서의 평가
- **최종 결정**: 안정성과 범용성을 고려하여 기본 YOLO 모델 유지

### v0.70 - 소켓 통신 구현
- **클라이언트-서버 구조**: 분석 결과를 외부 서버로 전송
- **JSON 데이터 전송**: 구조화된 데이터 형식으로 결과 전송
- **C++ 서버**: 결과를 수신하고 처리하는 C++ 서버 구현
- **실시간 통신**: 지연 없는 실시간 데이터 전송

### v0.80 - 세부 조정 및 편의성 개선
- **성능 최적화**: 처리 속도 및 메모리 사용량 개선
- **UI/UX 개선**: 사용자 인터페이스 및 경험 향상
- **버그 수정**: 안정성 및 신뢰성 향상
- **문서화**: 코드 및 사용법 문서화

### v0.90 - 위험 상태 감지 시스템
- **눈 감음 + 고개 숙임 동시 감지**: 가장 위험한 졸음 운전 상태 즉시 감지
- **MediaPipe 손 감지 로직 개선**: 손 개수별 차별화된 경고 시스템
- **위험 상태 시각적 강조**: 큰 폰트와 빨간색으로 위험 상태 표시
- **Result Server 업데이트**: 위험 상태 감지 메시지 출력 기능

### v0.91 - 얼굴 위치 필터링 및 정확도 향상
- **얼굴 위치 필터링 시스템**: 운전자 얼굴 캘리브레이션으로 다른 사람 얼굴 자동 필터링
- **동적 눈 깜빡임 임계값**: 고개 각도별 관대한 눈 감음 판정으로 자연스러운 동작 허용
- **손 크기 필터링 개선**: 얼굴 대비 손 크기 비율로 후방 승객 손 필터링
- **MediaPipe 실행 모드 개선**: 설정 파일 기반 모드 선택으로 GUI 단순화
- **안전성 및 정확도 향상**: 운전자 전용 분석으로 오탐 감소 및 간섭 방지

## ⚙️ 실행 방법

1.  **필수 라이브러리 설치:**
    ```bash
    pip install -r requirements.txt
    ```

2.  **dlib 모델 다운로드:**
    ```bash
    # models 디렉토리 생성
    mkdir -p models
    
    # dlib 얼굴 랜드마크 모델 다운로드
    wget http://dlib.net/files/shape_predictor_68_face_landmarks.dat.bz2
    bzip2 -d shape_predictor_68_face_landmarks.dat.bz2
    mv shape_predictor_68_face_landmarks.dat models/
    rm shape_predictor_68_face_landmarks.dat.bz2
    ```

3.  **프로그램 실행:**
    ```bash
    python gui_app.py
    ```

## 🔧 설정 튜닝

-   `config.json` 파일을 열어 각 모델의 임계값(threshold)과 연속 프레임 수(consecutive frames)를 조절할 수 있습니다.
-   GUI의 `Edit Config`와 `Reload Config` 버튼을 사용하면 실시간으로 설정을 변경하며 최적의 값을 찾을 수 있습니다.
-   특히 손 감지 민감도는 아래 값들을 수정하여 조절할 수 있습니다.
    ```json
    "mediapipe": {
        "min_hand_detection_confidence": 0.3,
        "min_hand_presence_confidence": 0.3,
        "hand_off_consec_frames": 5
    }
    ```

### 🎯 얼굴 위치 필터링 설정
운전자 얼굴 캘리브레이션 후 다른 사람의 얼굴을 필터링하는 강도를 조절할 수 있습니다:
```json
"dlib": {
    "face_position_threshold": 0.3,  // 위치 편차 허용 임계값 (얼굴 크기 대비)
    "face_size_threshold": 0.5,      // 크기 차이 허용 임계값 (비율)
    "enable_face_position_filtering": true  // 필터링 활성화 여부
}
```

### 🔧 동적 눈 깜빡임 임계값 설정
고개 각도에 따라 눈 감음 판정의 관대도를 조절할 수 있습니다:
```json
"mediapipe": {
    "eye_blink_threshold": 0.3,              // 정면 상태 기본 임계값
    "eye_blink_threshold_head_up": 0.2,      // 고개 들기 시 관대한 임계값
    "eye_blink_threshold_head_down": 0.25,   // 고개 숙이기 시 중간 임계값
    "head_up_threshold_for_eye": -10.0,      // 고개 들기 판정 기준 (도)
    "head_down_threshold_for_eye": 8.0       // 고개 숙이기 판정 기준 (도)
}
```

### 🖐️ 손 크기 필터링 설정
후방 승객의 작은 손들을 필터링하는 강도를 조절할 수 있습니다:
```json
"mediapipe": {
    "hand_size_ratio_threshold": 0.67,       // 손/얼굴 크기 비율 임계값 (2/3)
    "enable_hand_size_filtering": true       // 손 크기 필터링 활성화 여부
}
```

**📖 자세한 설정 가이드는 [README_CONFIG.md](README_CONFIG.md)를 참조하세요.** 